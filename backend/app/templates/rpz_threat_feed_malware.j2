; Malware Threat Feed RPZ Zone Template
; Generated automatically by Hybrid DNS Server
; Feed Name: {{ feed_name | default('Malware Feed') }}
; Feed Source: {{ feed_source | default('external') }}
; Feed URL: {{ feed_url | default('N/A') }}
; Total Malware Domains: {{ rules|length }}
; Active Rules: {{ active_rules_count | default(0) }}
; Last Feed Update: {{ feed_last_updated.strftime('%Y-%m-%d %H:%M:%S') if feed_last_updated else 'Never' }}
; Zone Generated: {{ generated_at.strftime('%Y-%m-%d %H:%M:%S') }}

$TTL {{ ttl | default(60) }}
$ORIGIN {{ feed_zone | default('malware') }}.rpz.

; SOA Record for Malware Threat Feed RPZ Zone
@	IN	SOA	{{ primary_ns | default('localhost.') }} {{ admin_email | default('admin.localhost.') }} (
		{{ serial | default(generated_at.strftime('%Y%m%d%H')) }}	; Serial number (YYYYMMDDHH)
		{{ refresh | default(900) }}		; Refresh interval (15 minutes - frequent updates for malware)
		{{ retry | default(300) }}		; Retry interval (5 minutes)
		{{ expire | default(604800) }}		; Expire time (1 week)
		{{ minimum | default(60) }}		; Minimum TTL (1 minute - fast updates)
		)

; Name Server Record
@	IN	NS	{{ primary_ns | default('localhost.') }}

; Malware Threat Feed Information
; Feed Type: Malware Protection
; Feed Description: {{ feed_description | default('External malware threat intelligence feed') }}
; Update Frequency: {{ feed_update_frequency | default('hourly') }}
; Feed Format: {{ feed_format | default('domain-list') }}
; Feed Reliability: {{ feed_reliability | default('high') }}
; Threat Categories: Malware, Trojans, Viruses, Ransomware, Botnets

{% if rules %}
; Malware Domain Rules ({{ rules|length }} total, {{ active_rules_count | default(0) }} active)

{% set malware_rules = [] %}
{% set ransomware_rules = [] %}
{% set botnet_rules = [] %}
{% set trojan_rules = [] %}
{% set virus_rules = [] %}
{% set other_malware = [] %}

{# Group malware rules by specific threat type #}
{% for rule in rules %}
{% if rule.is_active %}
{% set threat_type = rule.threat_type | default('malware') | lower %}
{% set threat_category = rule.threat_category | default('other') | lower %}
{% if threat_type == 'ransomware' or threat_category == 'ransomware' %}
{% set _ = ransomware_rules.append(rule) %}
{% elif threat_type == 'botnet' or threat_category == 'botnet' or threat_category == 'c2' %}
{% set _ = botnet_rules.append(rule) %}
{% elif threat_type == 'trojan' or threat_category == 'trojan' %}
{% set _ = trojan_rules.append(rule) %}
{% elif threat_type == 'virus' or threat_category == 'virus' %}
{% set _ = virus_rules.append(rule) %}
{% else %}
{% set _ = malware_rules.append(rule) %}
{% endif %}
{% endif %}
{% endfor %}

{# Ransomware Domains - Highest Priority #}
{% if ransomware_rules %}
; ========================================
; RANSOMWARE DOMAINS ({{ ransomware_rules|length }} rules)
; Domains associated with ransomware campaigns
; CRITICAL THREAT LEVEL - IMMEDIATE BLOCKING
; ========================================
{% for rule in ransomware_rules | sort(attribute='domain') %}
{% if rule.threat_description %}; Threat: {{ rule.threat_description }}{% endif %}
{% if rule.ransomware_family %}; Family: {{ rule.ransomware_family }}{% endif %}
{% if rule.first_seen %}; First Seen: {{ rule.first_seen.strftime('%Y-%m-%d') }}{% endif %}
{% if rule.confidence_score %}; Confidence: {{ rule.confidence_score }}%{% endif %}
{% if rule.severity %}; Severity: {{ rule.severity }}{% endif %}
{{ rule.domain | rpz_format_domain }}	IN	CNAME	.{% if rule.ioc_id %} ; IOC: {{ rule.ioc_id }}{% endif %}
{% endfor %}

{% endif %}
{# Botnet/C2 Domains #}
{% if botnet_rules %}
; ========================================
; BOTNET/C2 DOMAINS ({{ botnet_rules|length }} rules)
; Command and control servers and botnet infrastructure
; HIGH THREAT LEVEL - IMMEDIATE BLOCKING
; ========================================
{% for rule in botnet_rules | sort(attribute='domain') %}
{% if rule.threat_description %}; Threat: {{ rule.threat_description }}{% endif %}
{% if rule.botnet_family %}; Botnet Family: {{ rule.botnet_family }}{% endif %}
{% if rule.c2_type %}; C2 Type: {{ rule.c2_type }}{% endif %}
{% if rule.first_seen %}; First Seen: {{ rule.first_seen.strftime('%Y-%m-%d') }}{% endif %}
{% if rule.confidence_score %}; Confidence: {{ rule.confidence_score }}%{% endif %}
{{ rule.domain | rpz_format_domain }}	IN	CNAME	.{% if rule.ioc_id %} ; IOC: {{ rule.ioc_id }}{% endif %}
{% endfor %}

{% endif %}
{# Trojan Domains #}
{% if trojan_rules %}
; ========================================
; TROJAN DOMAINS ({{ trojan_rules|length }} rules)
; Domains hosting trojan malware
; HIGH THREAT LEVEL
; ========================================
{% for rule in trojan_rules | sort(attribute='domain') %}
{% if rule.threat_description %}; Threat: {{ rule.threat_description }}{% endif %}
{% if rule.trojan_type %}; Trojan Type: {{ rule.trojan_type }}{% endif %}
{% if rule.first_seen %}; First Seen: {{ rule.first_seen.strftime('%Y-%m-%d') }}{% endif %}
{% if rule.confidence_score %}; Confidence: {{ rule.confidence_score }}%{% endif %}
{{ rule.domain | rpz_format_domain }}	IN	CNAME	.{% if rule.ioc_id %} ; IOC: {{ rule.ioc_id }}{% endif %}
{% endfor %}

{% endif %}
{# Virus Domains #}
{% if virus_rules %}
; ========================================
; VIRUS DOMAINS ({{ virus_rules|length }} rules)
; Domains hosting computer viruses
; MEDIUM-HIGH THREAT LEVEL
; ========================================
{% for rule in virus_rules | sort(attribute='domain') %}
{% if rule.threat_description %}; Threat: {{ rule.threat_description }}{% endif %}
{% if rule.virus_type %}; Virus Type: {{ rule.virus_type }}{% endif %}
{% if rule.first_seen %}; First Seen: {{ rule.first_seen.strftime('%Y-%m-%d') }}{% endif %}
{% if rule.confidence_score %}; Confidence: {{ rule.confidence_score }}%{% endif %}
{{ rule.domain | rpz_format_domain }}	IN	CNAME	.{% if rule.ioc_id %} ; IOC: {{ rule.ioc_id }}{% endif %}
{% endfor %}

{% endif %}
{# General Malware Domains #}
{% if malware_rules %}
; ========================================
; GENERAL MALWARE DOMAINS ({{ malware_rules|length }} rules)
; Other malicious domains and suspicious content
; MEDIUM THREAT LEVEL
; ========================================
{% for rule in malware_rules | sort(attribute='domain') %}
{% if rule.threat_description %}; Threat: {{ rule.threat_description }}{% endif %}
{% if rule.malware_type %}; Malware Type: {{ rule.malware_type }}{% endif %}
{% if rule.first_seen %}; First Seen: {{ rule.first_seen.strftime('%Y-%m-%d') }}{% endif %}
{% if rule.confidence_score %}; Confidence: {{ rule.confidence_score }}%{% endif %}
{{ rule.domain | rpz_format_domain }}	IN	CNAME	.{% if rule.ioc_id %} ; IOC: {{ rule.ioc_id }}{% endif %}
{% endfor %}

{% endif %}
{% else %}
; No malware threat intelligence rules available
; Feed may be empty or all rules are inactive
{% endif %}

; Malware Feed Statistics:
; Total Rules: {{ rules|length }}
; Active Rules: {{ active_rules_count | default(0) }}
; Ransomware Domains: {{ ransomware_rules|length if ransomware_rules else 0 }}
; Botnet/C2 Domains: {{ botnet_rules|length if botnet_rules else 0 }}
; Trojan Domains: {{ trojan_rules|length if trojan_rules else 0 }}
; Virus Domains: {{ virus_rules|length if virus_rules else 0 }}
; Other Malware: {{ malware_rules|length if malware_rules else 0 }}

; Feed Metadata:
; Feed Source: {{ feed_source | default('external') }}
; Feed URL: {{ feed_url | default('N/A') }}
; Feed Format: {{ feed_format | default('domain-list') }}
; Last Updated: {{ feed_last_updated.strftime('%Y-%m-%d %H:%M:%S') if feed_last_updated else 'Never' }}
; Next Update: {{ feed_next_update.strftime('%Y-%m-%d %H:%M:%S') if feed_next_update else 'Unknown' }}
; Update Frequency: {{ feed_update_frequency | default('hourly') }}
; Feed Reliability: {{ feed_reliability | default('high') }}

; Security Notice:
; This zone contains domains identified as hosting malware or malicious content.
; All domains in this zone are blocked to protect network security.
; Regular updates ensure protection against new threats.

; Template Information:
; Template: rpz_threat_feed_malware.j2
; Generated: {{ generated_at.strftime('%Y-%m-%d %H:%M:%S') }}
; Zone: {{ feed_zone | default('malware') }}.rpz

; End of Malware Threat Feed RPZ zone file