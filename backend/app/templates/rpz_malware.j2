; Response Policy Zone - Malware Protection
; Generated automatically by Hybrid DNS Server
; Category: Malware Protection
; Description: Blocks known malicious domains and malware distribution sites
; Total Rules: {{ rules|length if rules else 0 }}
; Active Rules: {{ active_rules_count | default(0) }}
; Last Updated: {{ generated_at.strftime('%Y-%m-%d %H:%M:%S') }}
; Threat Intelligence Sources: {{ threat_sources | join(', ') if threat_sources else 'Manual' }}

$TTL {{ ttl | default(60) }}
$ORIGIN {{ zone_name | default('rpz.malware') }}.

; SOA Record for Malware Protection RPZ
@	IN	SOA	{{ primary_ns | default('localhost.') }} {{ admin_email | default('admin.localhost.') }} (
		{{ serial | default(generated_at.strftime('%Y%m%d%H')) }}	; Serial number (YYYYMMDDHH)
		{{ refresh | default(86400) }}		; Refresh interval (24 hours)
		{{ retry | default(7200) }}		; Retry interval (2 hours)
		{{ expire | default(604800) }}		; Expire time (1 week)
		{{ minimum | default(60) }}		; Minimum TTL (1 minute)
		)

; Name Server Record
@	IN	NS	{{ primary_ns | default('localhost.') }}

; ========================================
; MALWARE PROTECTION RULES
; ========================================
; This zone blocks known malicious domains including:
; - Malware distribution sites
; - Command & Control (C2) servers
; - Exploit kits and landing pages
; - Trojan and virus hosting domains
; - Ransomware payment sites
; - Cryptomining malware domains

{% if rules %}
{% set malware_rules = [] %}
{% set c2_rules = [] %}
{% set exploit_rules = [] %}
{% set ransomware_rules = [] %}

{# Categorize malware rules by threat type #}
{% for rule in rules %}
{% if rule.is_active %}
{% if rule.threat_category == 'c2' or 'c2' in (rule.description | lower) %}
{% set _ = c2_rules.append(rule) %}
{% elif rule.threat_category == 'exploit' or 'exploit' in (rule.description | lower) %}
{% set _ = exploit_rules.append(rule) %}
{% elif rule.threat_category == 'ransomware' or 'ransomware' in (rule.description | lower) %}
{% set _ = ransomware_rules.append(rule) %}
{% else %}
{% set _ = malware_rules.append(rule) %}
{% endif %}
{% endif %}
{% endfor %}

{# Command & Control Servers - Highest Priority #}
{% if c2_rules %}
; Command & Control (C2) Servers ({{ c2_rules|length }} rules)
; These domains are used by malware to communicate with attackers
{% for rule in c2_rules | sort(attribute='domain') %}
{% if rule.description %}; {{ rule.description }}{% endif %}
{{ rule.domain | rpz_format_domain }}	IN	CNAME	rpz-drop.{% if rule.source %} ; Source: {{ rule.source }}{% endif %}{% if rule.confidence_score %} ; Confidence: {{ rule.confidence_score }}%{% endif %}
{% endfor %}

{% endif %}
{# Exploit Kits and Landing Pages #}
{% if exploit_rules %}
; Exploit Kits and Landing Pages ({{ exploit_rules|length }} rules)
; These domains host exploit kits and malicious landing pages
{% for rule in exploit_rules | sort(attribute='domain') %}
{% if rule.description %}; {{ rule.description }}{% endif %}
{{ rule.domain | rpz_format_domain }}	IN	CNAME	.{% if rule.source %} ; Source: {{ rule.source }}{% endif %}{% if rule.confidence_score %} ; Confidence: {{ rule.confidence_score }}%{% endif %}
{% endfor %}

{% endif %}
{# Ransomware Related Domains #}
{% if ransomware_rules %}
; Ransomware Related Domains ({{ ransomware_rules|length }} rules)
; These domains are associated with ransomware operations
{% for rule in ransomware_rules | sort(attribute='domain') %}
{% if rule.description %}; {{ rule.description }}{% endif %}
{{ rule.domain | rpz_format_domain }}	IN	CNAME	rpz-drop.{% if rule.source %} ; Source: {{ rule.source }}{% endif %}{% if rule.confidence_score %} ; Confidence: {{ rule.confidence_score }}%{% endif %}
{% endfor %}

{% endif %}
{# General Malware Domains #}
{% if malware_rules %}
; General Malware Domains ({{ malware_rules|length }} rules)
; Various malicious domains and malware distribution sites
{% for rule in malware_rules | sort(attribute='domain') %}
{% if rule.description %}; {{ rule.description }}{% endif %}
{{ rule.domain | rpz_format_domain }}	IN	CNAME	.{% if rule.source %} ; Source: {{ rule.source }}{% endif %}{% if rule.confidence_score %} ; Confidence: {{ rule.confidence_score }}%{% endif %}
{% endfor %}

{% endif %}
{% else %}
; No active malware protection rules defined
; This zone is currently empty - consider importing threat intelligence feeds
{% endif %}

; ========================================
; THREAT INTELLIGENCE INTEGRATION
; ========================================
{% if threat_feeds %}
; Active Threat Intelligence Feeds:
{% for feed in threat_feeds %}
; - {{ feed.name }}: {{ feed.url }} (Last Updated: {{ feed.last_updated.strftime('%Y-%m-%d %H:%M') if feed.last_updated else 'Never' }})
{% endfor %}
{% else %}
; No threat intelligence feeds configured
; Consider integrating with commercial or open-source threat feeds
{% endif %}

; ========================================
; STATISTICS SUMMARY
; ========================================
; Total Rules: {{ rules|length if rules else 0 }}
; Active Rules: {{ active_rules_count | default(0) }}
; C2 Servers: {{ c2_rules|length if c2_rules else 0 }}
; Exploit Kits: {{ exploit_rules|length if exploit_rules else 0 }}
; Ransomware: {{ ransomware_rules|length if ransomware_rules else 0 }}
; General Malware: {{ malware_rules|length if malware_rules else 0 }}
; Average Confidence: {{ average_confidence | default('N/A') }}%

; End of Malware Protection RPZ zone